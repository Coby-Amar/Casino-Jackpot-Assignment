<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Casino Jackpot</title>
    <link rel="stylesheet" href="index.css">
</head>

<body>
    <table>
        <thead>
            <tr>
                <th colspan="3">
                    <button id="cashOut">Cash Out</button>
                </th>
            </tr>
            <tr>
                <th colspan="3">
                    Welcome to Casino Jackpot
                </th>
            </tr>
            <tr>
                <th colspan="3" id="credits"></th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td class="slot" id="slot1">W</td>
                <td class="slot" id="slot2">C</td>
                <td class="slot" id="slot3">L</td>
            </tr>
            <tr></tr>
        </tbody>
        <tfoot>
            <tr>
                <td colspan="3">
                    <button id="spin">Spin</button>
                </td>
            </tr>
        </tfoot>
    </table>
    <script>
        const spinButton = document.getElementById('spin');
        const cashOutButton = document.getElementById('cashOut');

        // Start game button click handler
        spinButton.onclick = () => {
            // Simulate spinning

            fetch('/slots/roll', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error)
                        return
                    }
                    setDisable()
                    document.querySelectorAll('.slot').forEach((slot, index) => slot.textContent = 'X');
                    const [slot1, slot2, slot3] = data.results
                    setTimeout(() => document.getElementById('slot1').textContent = slot1.name, 1000);
                    setTimeout(() => document.getElementById('slot2').textContent = slot2.name, 2000);
                    setTimeout(() => {
                        document.getElementById('slot3').textContent = slot3.name
                        setTimeout(() => {
                            updateCredits(data.credits)
                            setDisable(false)
                            if (data.isWinner) {
                                alert('You won!');
                            } else {
                                alert('You lost');
                            }
                        })
                    }, 3000);
                })
                .catch(err => {
                    console.error('err: ', err)
                    // Not enough credits
                    // if (err) {

                    // }
                });
        }

        // Cash out button click handler
        cashOutButton.onclick = () => fetch('/slots/cashout', { method: 'POST' })
            .then(response => response.json())
            .then((data) => {
                updateCredits(0)
                setDisable()
                alert(`You cashed out ${data} credits!`)
            })
            .catch(err => console.error('Error:', err));


        // Initialize the game session
        fetch('/slots/start')
            .then(response => response.json())
            .then(updateCredits);
        function updateCredits(credits) {
            document.getElementById('credits').textContent = `Credits: ${credits}`
        }
        const disabled = 'disabled'
        function setDisable(setTo = true) {
            if (setTo) {
                cashOutButton.setAttribute(disabled, setTo)
                spinButton.setAttribute(disabled, setTo)
            } else {
                cashOutButton.removeAttribute(disabled)
                spinButton.removeAttribute(disabled)
            }
        }
    </script>
</body>

</html>